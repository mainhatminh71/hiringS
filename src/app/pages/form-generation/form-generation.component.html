<div class="relative min-h-screen flex">
  <!-- Left Toolbox -->
  <app-left-side [visible]="sidebarVisible" (visibleChange)="onSidebarChange($event)">
    <div class="space-y-2">
      <h3 class="px-3 py-2 text-xs font-semibold text-gray-500 uppercase">Components</h3>
      
      @if (isLoading()) {
        <div class="px-3 py-2 text-sm text-gray-400">I would say: Gau Gau...</div>
    
      } @else {
        <div 
          cdkDropList
          id="toolboxDropList"
          [cdkDropListData]="toolboxData()"
          [cdkDropListConnectedTo]="['canvasDropList']"
          class="space-y-1">
          
          @for (item of toolboxItems(); track item.componentType) {
            <div 
              cdkDrag
              [cdkDragData]="{type: item.componentType}"
              class="flex items-center gap-2 px-3 py-2.5 rounded-md text-gray-700 hover:bg-gray-100 cursor-move transition-colors">
              <nz-icon [nzType]="item.icon" nzTheme="outline" class="text-base"></nz-icon>
              <span class="text-sm font-medium">{{ item.displayName }}</span>
            </div>
          }
        </div>
      }
    </div>
  </app-left-side>
  
  <!-- Main Content -->
  <div class="flex-1 p-6">
    <div class="flex justify-between items-center mb-4">
      <h1 class="text-2xl font-semibold">Form Builder</h1>
      
      <div class="flex items-center gap-4">
        <!-- Grid Config Controls -->
        <div class="flex items-center gap-2">
          <label class="text-sm text-gray-600">Grid:</label>
          <select 
            [value]="gridConfig().columns"
            (change)="updateGridConfig({columns: +$any($event.target).value})"
            aria-label="Select number of grid columns"
            title="Select number of grid columns"
            class="px-2 py-1 border border-gray-300 rounded text-sm">
            <option value="12">12 cols</option>
            <option value="16">16 cols</option>
            <option value="24">24 cols</option>
          </select>
          
          <button 
            (click)="toggleGridLines()"
            [class.bg-blue-500]="gridConfig().showGridLines"
            [class.text-white]="gridConfig().showGridLines"
            [class.bg-gray-100]="!gridConfig().showGridLines"
            class="px-3 py-1 border border-gray-300 rounded text-sm hover:bg-gray-200 transition-colors">
            Grid Lines
          </button>
        </div>
        
      </div>
    </div>
    
    <div class="flex gap-6">
      <!-- Canvas với Grid System -->
      <div class="flex-1 flex justify-center">
        <div 
          cdkDropList
          id="canvasDropList"
          [cdkDropListData]="formFields()"
          (cdkDropListDropped)="onDrop($event)"
          class="min-h-[1500px] bg-white border-2 border-dashed border-gray-300 rounded-lg p-8 relative w-[1500px]">
          
          <!-- Grid Overlay (visual guide) -->
          @if (gridConfig().showGridLines) {
            <div 
              class="absolute inset-8 pointer-events-none z-0"
              [style.display]="'grid'"
              [style.grid-template-columns]="gridColumnsStyle()"
              [style.gap.px]="gridConfig().gap">
              @for (col of [].constructor(gridConfig().columns); track $index) {
                <div class="border-l border-dashed border-gray-200"></div>
              }
            </div>
          }
          
          <!-- Grid Container cho Fields -->
          <div 
            class="relative z-10"
            [style.display]="'grid'"
            [style.grid-template-columns]="gridColumnsStyle()"
            [style.gap.px]="gridConfig().gap">
            
            @if (formFields().length === 0) {
              <div class="col-span-full flex items-center justify-center h-full text-gray-400">
                <div class="text-center">
                  <p class="text-lg mb-2">Drag From Sidebar To Here</p>
                  <p class="text-sm">Start by dragging a component from the sidebar</p>
                </div>
              </div>
            }
            
            @for (field of formFields(); track field.id) {
              <div 
                cdkDrag
                [cdkDragDisabled]="selectedField()?.id === field.id"
                [cdkDragData]="field"
                (click)="selectField(field)"
                [ngStyle]="getGridItemStyle(field)"
                [class.border-blue-500]="selectedField()?.id === field.id"
                [class.bg-blue-50]="selectedField()?.id === field.id"
                class="p-4 border-2 border-gray-200 rounded-lg bg-white cursor-pointer hover:border-gray-300 transition-colors relative group min-h-[60px] flex flex-col"
                [appResize]="selectedField()?.id === field.id"
                [minWidth]="200"
                [minHeight]="105"
                [maxHeight]="1300"
                [maxWidth]="1400"
                (resize)="onResize(field, $event)">
                
                <!-- Field Preview Component -->
                <div class="pointer-events-none flex-1 flex flex-col h-full w-full">
                  <app-field-preview [field]="field"></app-field-preview>
                </div>
                
                <!-- Resize Handles (chỉ hiện khi selected) -->
                @if (selectedField()?.id === field.id) {
                  <div 
                    class="resize-handle absolute top-0 left-0 w-6 h-6 cursor-nwse-resize z-20 -m-1" 
                    data-resize-handle="nw"
                    style="pointer-events: auto;"></div>
                  <div 
                    class="resize-handle absolute top-0 right-0 w-6 h-6 cursor-nesw-resize z-20 -m-1" 
                    data-resize-handle="ne"
                    style="pointer-events: auto;"></div>
                  <div 
                    class="resize-handle absolute bottom-0 left-0 w-6 h-6 cursor-nesw-resize z-20 -m-1" 
                    data-resize-handle="sw"
                    style="pointer-events: auto;"></div>
                  <div 
                    class="resize-handle absolute bottom-0 right-0 w-6 h-6 cursor-nwse-resize z-20 -m-1" 
                    data-resize-handle="se"
                    style="pointer-events: auto;"></div>
                  
                  <div 
                    class="resize-handle absolute top-0 left-1/2 -translate-x-1/2 w-6 h-6 cursor-ns-resize z-20 -m-1" 
                    data-resize-handle="n"
                    style="pointer-events: auto;"></div>
                  <div 
                    class="resize-handle absolute bottom-0 left-1/2 -translate-x-1/2 w-6 h-6 cursor-ns-resize z-20 -m-1" 
                    data-resize-handle="s"
                    style="pointer-events: auto;"></div>
                  <div 
                    class="resize-handle absolute left-0 top-1/2 -translate-y-1/2 w-6 h-6 cursor-ew-resize z-20 -m-1" 
                    data-resize-handle="w"
                    style="pointer-events: auto;"></div>
                  <div 
                    class="resize-handle absolute right-0 top-1/2 -translate-y-1/2 w-6 h-6 cursor-ew-resize z-20 -m-1" 
                    data-resize-handle="e"
                    style="pointer-events: auto;"></div>
                }
                
                <!-- Remove Button -->
                <button 
                  (click)="removeField(field.id); $event.stopPropagation()"
                  class="absolute top-2 right-2 opacity-0 group-hover:opacity-100 p-1 bg-red-500 text-white rounded text-xs hover:bg-red-600 transition-opacity z-10">
                  ×
                </button>
              </div>
            }
          </div>
        </div>
      </div>
      

    </div>
  </div>
</div>